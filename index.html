<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte du Trajet du Bus</title>
  <style>
    /* Styles de base */
    #map {
      height: 500px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Suivi du Passage du Bus</h1>
  <div id="map"></div>
  <!-- Ajout d'un bouton pour signaler le passage du bus -->
<button onclick="handleBusPassed()">Le bus est passé chez moi</button>

<script>
  // Fonction pour envoyer le signal de passage à Google Sheets
  async function handleBusPassed() {
    const name = prompt("Quel est votre prénom ?");
    if (!name) return;

    // Obtenez la position actuelle
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const entry = {
          name: name,
          time: new Date().toLocaleTimeString(),
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
        };

        // Envoyer les données à Google Sheets via l'API de script
        await fetch('URL_DE_TON_SCRIPT_GOOGLE_APPS', {
          method: 'POST',
          body: JSON.stringify(entry),
          headers: {
            'Content-Type': 'application/json',
          }
        });

        // Mettre à jour la carte (ajouter le marqueur)
        updateMap(entry);
      });
    }
  }

  // Fonction pour mettre à jour la carte avec les nouvelles données
  function updateMap(entry) {
    const marker = new google.maps.Marker({
      position: { lat: entry.lat, lng: entry.lng },
      map: map,
      title: entry.name,
      icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png', // Marqueur vert
    });

    markers.push(marker);
  }
</script>


  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7jDT32wCQUq7d_PR9X4L6ioXgomQcBNQ&callback=initMap" async defer></script>
  <script>
  let map;
  let markers = [];
  const stops = [];

  // Fonction pour récupérer les arrêts depuis Google Sheets
  async function getBusData() {
    const response = await fetch('URL_DE_TON_SCRIPT_GOOGLE_APPS');  // Remplace par l'URL du script Google Apps
    const data = await response.json();
    
    // Remplir le tableau 'stops' avec les données récupérées
    data.forEach(entry => {
      stops.push({
        name: entry.name,
        lat: entry.lat,
        lng: entry.lng,
        passed: false // Par défaut, l'arrêt est "pas encore passé"
      });
    });

    // Re-initialiser la carte avec les nouveaux arrêts
    initMap();
  }

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 36.7735, lng: 3.0582 },
      zoom: 12,
    });

    // Ajouter un marqueur pour chaque arrêt
    stops.forEach((stop, idx) => {
      const marker = new google.maps.Marker({
        position: { lat: stop.lat, lng: stop.lng },
        map: map,
        title: stop.name,
        icon: stop.passed ? 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' : 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
      });

      markers.push(marker);
    });

    // Estimation des horaires
    estimateArrivalTimes();
  }

  // Appeler la fonction pour obtenir les données de Google Sheets au chargement de la page
  window.onload = function() {
    getBusData();
  };
</script>
  
</body>
</html>
