<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
        }
        .location-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 5px;
            border-left: 5px solid #3498db;
        }
        .destination-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f8f5;
            border-radius: 5px;
            border-left: 5px solid #1abc9c;
        }
        .bus-action {
            margin-top: 20px;
            padding: 15px;
            background-color: #fef9e7;
            border-radius: 5px;
            border-left: 5px solid #f1c40f;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .loading {
            text-align: center;
            font-style: italic;
            color: #7f8c8d;
        }
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 10px;
            background-color: #fadbd8;
            border-radius: 5px;
            margin-top: 20px;
        }
        .estimate {
            font-weight: bold;
            color: #2980b9;
        }
        .refresh-btn, .report-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .report-btn {
            background-color: #2ecc71;
            width: 100%;
            max-width: 300px;
        }
        .report-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .refresh-btn:hover, .report-btn:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .report-btn:hover:not(:disabled) {
            background-color: #27ae60;
        }
        .distance {
            font-weight: bold;
        }
        .bus-line {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
        }
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9e79f;
            border-radius: 5px;
            border-left: 5px solid #f1c40f;
            font-family: monospace;
            white-space: pre-wrap;
            display: none;
        }
        .debug-toggle {
            margin-top: 20px;
            text-align: center;
            color: #7f8c8d;
            cursor: pointer;
        }
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .login-box {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .login-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .login-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .login-error {
            color: #e74c3c;
            margin-top: 10px;
        }
        .bus-stop-selector {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .status-reported {
            font-weight: bold;
            color: #2ecc71;
        }
        .status-message {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        .status-success {
            background-color: #d5f5e3;
            color: #27ae60;
            border: 1px solid #2ecc71;
        }
        .status-error {
            background-color: #fadbd8;
            color: #c0392b;
            border: 1px solid #e74c3c;
        }
        .qr-hint {
            font-size: 14px;
            font-style: italic;
            color: #7f8c8d;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h2>Bus Tracker - Accès</h2>
            <p>Veuillez entrer le code d'accès pour continuer</p>
            <input type="password" id="access-code" class="login-input" placeholder="Code d'accès (4247)" autocomplete="off">
            <button id="login-btn" class="login-btn">Accéder</button>
            <p id="login-error" class="login-error"></p>
            <p class="qr-hint">Scannez le QR code à l'intérieur du bus pour accéder directement</p>
        </div>
    </div>

    <div class="container">
        <h1>Bus Tracker</h1>
        <div class="bus-line-info" style="text-align: center;">
            <span class="bus-line" id="bus-line"></span>
        </div>
        
        <div id="current-location" class="location-info">
            <p class="loading">Récupération de votre position...</p>
        </div>
        
        <div class="destination-info" id="destination-info">
            <p class="loading">Chargement des informations de destination...</p>
        </div>

        <!-- Nouveau: Section d'action de signalement du bus -->
        <div class="bus-action" id="bus-action">
            <h3>Signaler le passage du bus</h3>
            <select id="bus-stop-selector" class="bus-stop-selector">
                <option value="">Sélectionnez votre arrêt</option>
                <!-- Options chargées dynamiquement -->
            </select>
            <button id="report-bus-btn" class="report-btn" disabled>Signaler le passage du bus à cet arrêt</button>
            <div id="status-message" class="status-message"></div>
            <p class="qr-hint">Vous ne pouvez signaler le passage du bus qu'une seule fois par jour</p>
        </div>
        
        <div class="history">
            <h2>Données de suivi du bus (Dernières 24h)</h2>
            <p>Triées par distance à la destination finale (plus éloignées d'abord)</p>
            <table id="tracking-table">
                <thead>
                    <tr>
                        <th>Arrêt</th>
                        <th>Heure</th>
                        <th>Distance à l'arrivée</th>
                        <th>Arrivée estimée</th>
                    </tr>
                </thead>
                <tbody id="tracking-data">
                    <tr>
                        <td colspan="4" class="loading">Chargement des données de suivi...</td>
                    </tr>
                </tbody>
            </table>
            <button id="refresh-btn" class="refresh-btn">Actualiser les données</button>
        </div>
        
        <div id="debug-info" class="debug-info"></div>
        <div class="debug-toggle" id="debug-toggle">Afficher les infos de débogage</div>
    </div>

    <!-- Firebase App (core) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.17.2/firebase-app-compat.min.js"></script>
    <!-- Firebase Database -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.17.2/firebase-database-compat.min.js"></script>

    <script>
        // CONFIGURATION: REMPLACEZ CES VALEURS PAR LES INFORMATIONS SPÉCIFIQUES À VOTRE LIGNE DE BUS
        const BUS_LINE = "Line 4742";
        const DESTINATION_NAME = "Central Station";
        const DESTINATION_COORDS = {
            latitude: 48.858844,  // Remplacez par les coordonnées réelles
            longitude: 2.294351   // Remplacez par les coordonnées réelles
        };
        const BUS_ID = "bus-line-42"; // ID unique pour votre ligne de bus (pour la base de données)
        const ACCESS_CODE = "4247"; // Code d'accès pour protéger contre le vandalisme
        
        // Définition des arrêts de bus (à personnaliser selon vos besoins)
        const BUS_STOPS = [
            { id: "stop1", name: "Départ - Place du Marché", lat: 48.872222, lng: 2.295556, radius: 200 },
            { id: "stop2", name: "École Municipale", lat: 48.865983, lng: 2.293681, radius: 200 },
            { id: "stop3", name: "Centre Commercial", lat: 48.862222, lng: 2.292778, radius: 200 },
            { id: "stop4", name: "Bibliothèque", lat: 48.860611, lng: 2.293644, radius: 200 },
            { id: "stop5", name: "Parc Municipal", lat: 48.859583, lng: 2.294082, radius: 200 },
            { id: "destination", name: DESTINATION_NAME, lat: DESTINATION_COORDS.latitude, lng: DESTINATION_COORDS.longitude, radius: 200 }
        ];
        
        // Fonction de journalisation du débogage
        function debugLog(message, data = null) {
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            let logMessage = `[${timestamp}] ${message}`;
            
            if (data) {
                if (typeof data === 'object') {
                    try {
                        logMessage += "\n" + JSON.stringify(data, null, 2);
                    } catch (e) {
                        logMessage += "\n[Objet non stringifiable]";
                    }
                } else {
                    logMessage += "\n" + data;
                }
            }
            
            debugInfo.innerHTML += logMessage + "\n\n";
            console.log(message, data);
        }
        
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBub9gvQg0gARrTOd6EQnoJrpHoo_wjKx8",
            authDomain: "bustrack-cb124.firebaseapp.com",
            databaseURL: "https://bustrack-cb124-default-rtdb.firebaseio.com",
            projectId: "bustrack-cb124",
            storageBucket: "bustrack-cb124.firebasestorage.app",
            messagingSenderId: "1010286119665",
            appId: "1:1010286119665:web:2158ebf53bf7af3641f750"
        };

        // Initialiser Firebase
        let database, trackingRef;
        try {
            debugLog("Initialisation de Firebase...");
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            trackingRef = database.ref('bustracking/' + BUS_ID);
            debugLog("Firebase initialisé avec succès");
            
            // Tester la connexion à la base de données
            database.app.INTERNAL.getToken()
                .then(() => {
                    debugLog("Connexion Firebase vérifiée");
                })
                .catch(error => {
                    debugLog("Erreur de connexion Firebase", error);
                    showError("Impossible de se connecter à la base de données. Vérifiez votre connexion internet et réessayez.");
                });
        } catch (error) {
            debugLog("Erreur d'initialisation Firebase", error);
            showError("Erreur d'initialisation de la base de données. Veuillez réessayer plus tard.");
        }
        
        // Variables d'état
        let currentCoords = null;
        let averageSpeed = 30; // km/h - vitesse de bus par défaut
        let userAuthenticated = false;
        let nearestStop = null;
        let hasReportedToday = false;

        // Vérifier si l'utilisateur a déjà signalé un bus aujourd'hui
        function checkPreviousReport() {
            try {
                const lastReport = localStorage.getItem('lastBusReport_' + BUS_ID);
                if (lastReport) {
                    const reportDate = new Date(lastReport);
                    const today = new Date();
                    
                    if (reportDate.toDateString() === today.toDateString()) {
                        hasReportedToday = true;
                        document.getElementById('report-bus-btn').disabled = true;
                        document.getElementById('report-bus-btn').textContent = "Vous avez déjà signalé un passage aujourd'hui";
                        debugLog("L'utilisateur a déjà signalé un bus aujourd'hui");
                        return true;
                    }
                }
                return false;
            } catch (error) {
                debugLog("Erreur lors de la vérification des rapports précédents", error);
                return false;
            }
        }

        // Fonction pour afficher les messages d'erreur
        function showError(message, elementId = 'tracking-data') {
            const element = document.getElementById(elementId);
            if (element) {
                if (elementId === 'tracking-data') {
                    element.innerHTML = `<tr><td colspan="4" class="error">${message}</td></tr>`;
                } else {
                    element.innerHTML = `<div class="error">${message}</div>`;
                }
            }
            debugLog("ERREUR: " + message);
        }

        // Fonction pour afficher un message de statut
        function showStatusMessage(message, isSuccess = true) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            
            if (isSuccess) {
                statusElement.className = 'status-message status-success';
            } else {
                statusElement.className = 'status-message status-error';
            }
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Fonction pour obtenir la date et l'heure actuelles formatées
        function getCurrentDateTime() {
            const now = new Date();
            return now.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        // Fonction pour calculer la distance entre deux coordonnées (formule de Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Rayon de la terre en km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            const distance = R * c; // Distance en km
            return distance;
        }
        
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        // Fonction pour estimer l'heure d'arrivée en fonction de la distance et de la vitesse moyenne
        function estimateArrival(distanceKm) {
            const timeHours = distanceKm / averageSpeed;
            const timeMinutes = timeHours * 60;
            
            const now = new Date();
            const arrivalTime = new Date(now.getTime() + timeMinutes * 60000);
            
            return arrivalTime.toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        // Fonction pour trouver l'arrêt de bus le plus proche
        function findNearestBusStop(latitude, longitude) {
            let nearestStop = null;
            let shortestDistance = Infinity;
            
            BUS_STOPS.forEach(stop => {
                const distance = calculateDistance(latitude, longitude, stop.lat, stop.lng);
                if (distance < shortestDistance) {
                    shortestDistance = distance;
                    nearestStop = stop;
                }
            });
            
            // Vérifier si l'utilisateur est dans le rayon de l'arrêt
            if (shortestDistance <= (nearestStop.radius / 1000)) { // Convertir le rayon de mètres en km
                return nearestStop;
            }
            
            return null;
        }

        // Fonction pour nettoyer les entrées de plus de 24 heures
        function cleanDatabase() {
            debugLog("Nettoyage de la base de données des anciennes entrées");

            if (!trackingRef) {
                debugLog("Impossible de nettoyer la base de données: référence Firebase non initialisée");
                return;
            }

            try {
                // Lire toutes les entrées UNE FOIS pour identifier les anciennes
                trackingRef.once('value')
                    .then(snapshot => {
                        const entries = snapshot.val();
                        debugLog(`La base de données contient ${entries ? Object.keys(entries).length : 0} entrées avant le nettoyage`);

                        if (!entries) {
                            debugLog("Pas d'entrées à nettoyer");
                            return;
                        }

                        const now = new Date();
                        const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                        let cleanedCount = 0;

                        // Parcourir les entrées et supprimer les anciennes
                        Object.keys(entries).forEach(key => {
                            const entry = entries[key];
                            if (!entry || !entry.timestamp) {
                                debugLog(`Ignorer l'entrée invalide avec la clé: ${key}`, entry);
                                return;
                            }

                            const entryDate = new Date(entry.timestamp);

                            if (entryDate < twentyFourHoursAgo) {
                                // Cette entrée date de plus de 24 heures, la supprimer
                                const entryToRemoveRef = trackingRef.child(key);
                                entryToRemoveRef.remove()
                                    .then(() => {
                                        debugLog(`Ancienne entrée supprimée avec la clé: ${key}`);
                                        cleanedCount++;
                                    })
                                    .catch(error => {
                                        debugLog(`Erreur lors de la suppression de l'entrée avec la clé ${key}`, error);
                                    });
                            }
                        });

                        if (cleanedCount > 0) {
                            debugLog(`Nettoyage terminé. ${cleanedCount} anciennes entrées ont été supprimées.`);
                        } else {
                            debugLog("Aucune ancienne entrée trouvée à supprimer.");
                        }
                    })
                    .catch(error => {
                        debugLog("Erreur lors de la récupération des entrées de la base de données pour le nettoyage", error);
                    });
            } catch (error) {
                debugLog("Erreur dans l'exécution de la fonction cleanDatabase", error);
            }
        }

        // Fonction pour signaler le passage du bus
        function reportBusPassage() {
            if (hasReportedToday) {
                showStatusMessage("Vous avez déjà signalé un passage aujourd'hui", false);
                return;
            }
            
            const busStopSelector = document.getElementById('bus-stop-selector');
            const selectedStopId = busStopSelector.value;
            
            if (!selectedStopId) {
                showStatusMessage("Veuillez sélectionner un arrêt de bus", false);
                return;
            }
            
            const selectedStop = BUS_STOPS.find(stop => stop.id === selectedStopId);
            if (!selectedStop) {
                showStatusMessage("Arrêt non trouvé", false);
                return;
            }
            
            try {
                debugLog(`Signalement du passage du bus à: ${selectedStop.name}`);
                
                // Enregistrer le rapport dans la base de données
                saveTrackingEntry(selectedStop.name, selectedStop.lat, selectedStop.lng, true);
                
                // Marquer l'utilisateur comme ayant signalé aujourd'hui
                localStorage.setItem('lastBusReport_' + BUS_ID, new Date().toISOString());
                hasReportedToday = true;
                
                // Mettre à jour l'interface utilisateur
                document.getElementById('report-bus-btn').disabled = true;
                document.getElementById('report-bus-btn').textContent = "Passage signalé aujourd'hui";
                
                showStatusMessage("Merci! Le passage du bus a été signalé avec succès.", true);
            } catch (error) {
                debugLog("Erreur lors du signalement du passage du bus", error);
                showStatusMessage("Erreur lors du signalement du passage du bus. Veuillez réessayer.", false);
            }
        }

        // Fonction pour enregistrer une nouvelle entrée de suivi
        function saveTrackingEntry(locationName, latitude, longitude, isBusReport = false) {
            debugLog(`Enregistrement d'une entrée de suivi: ${locationName} (${latitude}, ${longitude})`);
            
            if (!trackingRef) {
                debugLog("Impossible d'enregistrer l'entrée de suivi: référence Firebase non initialisée");
                return;
            }
            
            try {
                const newEntryRef = trackingRef.push();
                const now = new Date();
                
                const entryData = {
                    locationName: locationName,
                    latitude: latitude,
                    longitude: longitude,
                    timestamp: now.toISOString(),
                    datetime: getCurrentDateTime(),
                    isBusReport: isBusReport
                };
                
                newEntryRef.set(entryData)
                    .then(() => {
                        debugLog("Entrée enregistrée avec succès");
                    })
                    .catch(error => {
                        debugLog("Erreur lors de l'enregistrement de l'entrée", error);
                        showError("Échec de l'enregistrement de votre position. Veuillez réessayer.");
                    });
            } catch (error) {
                debugLog("Erreur lors de la création de l'entrée", error);
                showError("Une erreur s'est produite lors de l'enregistrement de votre position.");
            }
        }

        // Fonction pour afficher les entrées de suivi triées par distance
        function displayTrackingEntries(entries) {
            debugLog("Affichage des entrées de suivi", entries);
            const trackingDataTable = document.getElementById('tracking-data');
            
            if (!entries || Object.keys(entries).length === 0) {
                trackingDataTable.innerHTML = '<tr><td colspan="4">Aucune donnée de suivi disponible pour l\'instant. Cliquez sur "Actualiser les données" pour enregistrer votre position actuelle.</td></tr>';
                return;
            }
            
            try {
                trackingDataTable.innerHTML = '';
                
                // Convertir l'objet en tableau et calculer les distances
                const entriesArray = Object.keys(entries).map(key => {
                    const entry = entries[key];
                    if (!entry || !entry.latitude || !entry.longitude) {
                        return null;
                    }
                    
                    const distance = calculateDistance(
                        entry.latitude, entry.longitude,
                        DESTINATION_COORDS.latitude, DESTINATION_COORDS.longitude
                    );
                    
                    return {
                        ...entry,
                        distance: distance,
                        estimatedArrival: estimateArrival(distance)
                    };
                }).filter(entry => entry !== null);
                
                if (entriesArray.length === 0) {
                    trackingDataTable.innerHTML = '<tr><td colspan="4">Aucune donnée de suivi valide disponible.</td></tr>';
                    return;
                }
                
                // Trier par distance (plus éloignées d'abord)
                entriesArray.sort((a, b) => b.distance - a.distance);
                
                // Afficher les entrées
                entriesArray.forEach(entry => {
                    const row = document.createElement('tr');
                    
                    let locationCell = entry.locationName || "Inconnu";
                    // Ajouter un indicateur si c'est un rapport de bus
                    if (entry.isBusReport) {
                        locationCell = `<span class="status-reported">${locationCell} ✓</span>`;
                    }
                    
                    row.innerHTML = `
                        <td>${locationCell}</td>
                        <td>${entry.datetime || "Inconnu"}</td>
                        <td><span class="distance">${entry.distance.toFixed(1)} km</span></td>
                        <td><span class="estimate">${entry.estimatedArrival}</span></td>
                    `;
                    
                    trackingDataTable.appendChild(row);
                });
                
                debugLog(`${entriesArray.length} entrées affichées`);
            } catch (error) {
                debugLog("Erreur lors de l'affichage des entrées de suivi", error);
                trackingDataTable.innerHTML = '<tr><td colspan="4" class="error">Erreur lors de l\'affichage des données de suivi. Veuillez actualiser la page.</td></tr>';
            }
        }

        // Fonction pour charger et afficher les informations de destination
        async function loadDestinationInfo() {
            debugLog("Chargement des informations de destination");
            const destinationDiv = document.getElementById('destination-info');
            
            try {
                // Récupérer le nom de la destination à partir des coordonnées si non déjà défini
                let destinationLocationName = DESTINATION_NAME;
                
                destinationDiv.innerHTML = `
                    <h3>Destination Finale</h3>
                    <p><strong>Lieu:</strong> ${destinationLocationName}</p>
                    <p><strong>Coordonnées:</strong> ${DESTINATION_COORDS.latitude}, ${DESTINATION_COORDS.longitude}</p>
                `;
                debugLog("Informations de destination chargées", { name: destinationLocationName, coords: DESTINATION_COORDS });
            } catch (error) {
                debugLog("Erreur lors du chargement des informations de destination", error);
                destinationDiv.innerHTML = `
                    <h3>Destination Finale</h3>
                    <p>${DESTINATION_NAME}</p>
                    <p class="error">Erreur lors du chargement des informations supplémentaires sur la destination.</p>
                `;
            }
        }

        // Charger les arrêts de bus dans le sélecteur
        function loadBusStopSelector() {
            const selector = document.getElementById('bus-stop-selector');
            selector.innerHTML = '<option value="">Sélectionnez votre arrêt</option>';
            
            BUS_STOPS.forEach(stop => {
                const option = document.createElement('option');
                option.value = stop.id;
                option.textContent = stop.name;
                selector.appendChild(option);
            });
            
            // Activer le bouton de signalement si l'utilisateur n'a pas encore signalé aujourd'hui
            if (!hasReportedToday) {
                document.getElementById('report-bus-btn').disabled = false;
            }
        }

        </script>

    <script>
        // Ajoutez ce code à la fin de votre fichier JavaScript

        // Gestion de la connexion
        document.addEventListener('DOMContentLoaded', function() {
            debugLog("Initialisation de l'application Bus Tracker");
            
            // Définir les éléments de l'interface de connexion
            const loginOverlay = document.getElementById('login-overlay');
            const accessCodeInput = document.getElementById('access-code');
            const loginBtn = document.getElementById('login-btn');
            const loginError = document.getElementById('login-error');
            
            // Vérifier si l'utilisateur est déjà authentifié (via localStorage)
            const isAuthenticated = localStorage.getItem('busTracker_authenticated');
            if (isAuthenticated === 'true') {
                loginOverlay.style.display = 'none';
                userAuthenticated = true;
                initializeApp();
                debugLog("Utilisateur déjà authentifié, initialisation de l'application");
                return;
            }
            
            // Événement pour le bouton de connexion
            loginBtn.addEventListener('click', function() {
                const enteredCode = accessCodeInput.value.trim();
                
                if (enteredCode === ACCESS_CODE) {
                    debugLog("Code d'accès valide, authentification réussie");
                    userAuthenticated = true;
                    loginOverlay.style.display = 'none';
                    
                    // Sauvegarder l'état d'authentification
                    localStorage.setItem('busTracker_authenticated', 'true');
                    
                    // Initialiser l'application
                    initializeApp();
                } else {
                    debugLog("Tentative de connexion échouée: code d'accès invalide");
                    loginError.textContent = "Code d'accès invalide. Veuillez réessayer.";
                    setTimeout(() => {
                        loginError.textContent = "";
                    }, 3000);
                }
            });
            
            // Permettre de soumettre avec la touche "Entrée"
            accessCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginBtn.click();
                }
            });
        });

        // Fonction pour initialiser l'application après authentification
        function initializeApp() {
            debugLog("Initialisation de l'application après authentification");
            
            // Afficher le nom de la ligne de bus
            document.getElementById('bus-line').textContent = BUS_LINE;
            
            // Charger les informations de destination
            loadDestinationInfo();
            
            // Charger les arrêts de bus dans le sélecteur
            loadBusStopSelector();
            
            // Vérifier si l'utilisateur a déjà signalé un bus aujourd'hui
            checkPreviousReport();
            
            // Nettoyer la base de données des anciennes entrées
            cleanDatabase();
            
            // Initialiser les écouteurs d'événements
            document.getElementById('report-bus-btn').addEventListener('click', reportBusPassage);
            document.getElementById('refresh-btn').addEventListener('click', refreshData);
            
            // Activer le toggle de débogage
            const debugToggle = document.getElementById('debug-toggle');
            const debugInfo = document.getElementById('debug-info');
            debugToggle.addEventListener('click', function() {
                if (debugInfo.style.display === 'block') {
                    debugInfo.style.display = 'none';
                    debugToggle.textContent = 'Afficher les infos de débogage';
                } else {
                    debugInfo.style.display = 'block';
                    debugToggle.textContent = 'Masquer les infos de débogage';
                }
            });
            
            // Obtenir la position actuelle et charger les données de suivi
            getCurrentPosition();
        }

        // Fonction pour actualiser les données
        function refreshData() {
            debugLog("Actualisation des données");
            getCurrentPosition();
        }

        // Fonction pour obtenir la position actuelle
        function getCurrentPosition() {
            const currentLocationDiv = document.getElementById('current-location');
            currentLocationDiv.innerHTML = '<p class="loading">Récupération de votre position...</p>';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        // Succès
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        currentCoords = { latitude, longitude };
                        
                        // Trouver l'arrêt le plus proche
                        nearestStop = findNearestBusStop(latitude, longitude);
                        
                        let locationName = "Position actuelle";
                        if (nearestStop) {
                            locationName = `Près de: ${nearestStop.name}`;
                        }
                        
                        // Calculer la distance jusqu'à la destination
                        const distanceToDestination = calculateDistance(
                            latitude, longitude,
                            DESTINATION_COORDS.latitude, DESTINATION_COORDS.longitude
                        );
                        
                        currentLocationDiv.innerHTML = `
                            <h3>Votre position</h3>
                            <p><strong>Lieu:</strong> ${locationName}</p>
                            <p><strong>Coordonnées:</strong> ${latitude.toFixed(6)}, ${longitude.toFixed(6)}</p>
                            <p><strong>Distance à la destination:</strong> <span class="distance">${distanceToDestination.toFixed(1)} km</span></p>
                            <p><strong>Arrivée estimée:</strong> <span class="estimate">${estimateArrival(distanceToDestination)}</span></p>
                        `;
                        
                        // Enregistrer l'entrée dans la base de données (si authentifié)
                        if (userAuthenticated) {
                            saveTrackingEntry(locationName, latitude, longitude);
                        }
                        
                        // Récupérer et afficher les entrées de suivi
                        loadTrackingEntries();
                        
                        debugLog("Position actuelle récupérée", { latitude, longitude, nearestStop });
                    },
                    function(error) {
                        // Erreur
                        debugLog("Erreur de géolocalisation", error);
                        currentLocationDiv.innerHTML = `
                            <h3>Votre position</h3>
                            <div class="error">
                                <p>Impossible de récupérer votre position.</p>
                                <p>Erreur: ${getGeolocationErrorMessage(error)}</p>
                                <p>Veuillez autoriser l'accès à votre position ou essayez de recharger la page.</p>
                            </div>
                        `;
                    }
                );
            } else {
                debugLog("La géolocalisation n'est pas prise en charge par ce navigateur");
                currentLocationDiv.innerHTML = `
                    <h3>Votre position</h3>
                    <div class="error">
                        <p>La géolocalisation n'est pas prise en charge par votre navigateur.</p>
                        <p>Veuillez utiliser un navigateur plus récent.</p>
                    </div>
                `;
            }
        }

        // Fonction pour obtenir un message d'erreur de géolocalisation plus lisible
        function getGeolocationErrorMessage(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    return "Vous avez refusé l'accès à votre position.";
                case error.POSITION_UNAVAILABLE:
                    return "Les informations de position ne sont pas disponibles.";
                case error.TIMEOUT:
                    return "La demande de position a expiré.";
                case error.UNKNOWN_ERROR:
                    return "Une erreur inconnue s'est produite.";
                default:
                    return "Erreur inconnue.";
            }
        }

        // Fonction pour charger les entrées de suivi depuis la base de données
        function loadTrackingEntries() {
            debugLog("Chargement des entrées de suivi depuis la base de données");
            
            if (!trackingRef) {
                debugLog("Impossible de charger les entrées: référence Firebase non initialisée");
                document.getElementById('tracking-data').innerHTML = '<tr><td colspan="4" class="error">Impossible de se connecter à la base de données.</td></tr>';
                return;
            }
            
            try {
                trackingRef.once('value')
                    .then(snapshot => {
                        const entries = snapshot.val();
                        displayTrackingEntries(entries);
                    })
                    .catch(error => {
                        debugLog("Erreur lors du chargement des entrées de suivi", error);
                        document.getElementById('tracking-data').innerHTML = '<tr><td colspan="4" class="error">Erreur lors du chargement des données de suivi.</td></tr>';
                    });
            } catch (error) {
                debugLog("Erreur dans la fonction loadTrackingEntries", error);
                document.getElementById('tracking-data').innerHTML = '<tr><td colspan="4" class="error">Une erreur s'est produite lors du chargement des données.</td></tr>';
            }
        }
    </script>
</body>
</html>
