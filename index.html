<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Signalement Bus</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.17.2/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.17.2/firebase-database-compat.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    #login, #app { margin-bottom: 20px; }
    button { margin: 5px; padding: 10px 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
  </style>
</head>
<body>

<div id="login">
  <h3>Entrer le code PIN :</h3>
  <input type="password" id="pinInput" maxlength="4" />
  <button onclick="checkPIN()">Valider</button>
  <p id="pinError" style="color: red; display: none;">Code incorrect.</p>
</div>

<div id="app" style="display:none;">
  <h3>Signaler un arrêt</h3>
  <button onclick="sendStop('Zeralda')">Zeralda</button>
  <button onclick="sendStop('Sidi Abdallah')">Sidi Abdallah</button>
  <button onclick="sendStop('Douera')">Douera</button>
  <button onclick="useGeolocation()">📍 Utiliser ma position</button>

  <h4>Historique des arrêts</h4>
  <table>
    <thead><tr><th>Arrêt</th><th>Heure</th></tr></thead>
    <tbody id="historyBody"><tr><td colspan="2">Chargement...</td></tr></tbody>
  </table>
</div>

<script>
  const ACCESS_PIN = "1579";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBub9gvQg0gARrTOd6EQnoJrpHoo_wjKx8",
    authDomain: "bustrack-cb124.firebaseapp.com",
    databaseURL: "https://bustrack-cb124-default-rtdb.firebaseio.com",
    projectId: "bustrack-cb124",
    storageBucket: "bustrack-cb124.appspot.com",
    messagingSenderId: "1010286119665",
    appId: "1:1010286119665:web:2158ebf53bf7af3641f750"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database().ref("bustracking/simple");

  function checkPIN() {
    const input = document.getElementById('pinInput').value;
    if (input === ACCESS_PIN) {
      document.getElementById('login').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      loadStops();
    } else {
      document.getElementById('pinError').style.display = 'block';
    }
  }

  function sendStop(name, lat = null, lon = null) {
    const now = new Date();
    db.push({
      name: name,
      lat: lat,
      lon: lon,
      time: now.toLocaleString()
    });
  }

  function useGeolocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        sendStop("Ma position", latitude, longitude);
      }, () => {
        alert("Impossible d’obtenir la position.");
      });
    } else {
      alert("Géolocalisation non supportée.");
    }
  }

  function loadStops() {
    db.limitToLast(10).on('value', snapshot => {
      const body = document.getElementById('historyBody');
      body.innerHTML = '';
      const data = snapshot.val();
      if (data) {
        Object.values(data).reverse().forEach(entry => {
          const row = `<tr><td>${entry.name}</td><td>${entry.time}</td></tr>`;
          body.innerHTML += row;
        });
      } else {
        body.innerHTML = '<tr><td colspan="2">Aucun arrêt signalé.</td></tr>';
      }
    });
  }
</script>
</body>
</html>
