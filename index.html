<!DOCTYPE html>
<html lang="en">
<head>
  <!-- META + STYLE HEAD OMITTED FOR BREVITY, SAME AS AVANT.TXT -->
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-bus"></i> NeoTrack Bus</h1>

    <div class="pin-input glass-card">
      <label for="pin"><i class="fas fa-lock"></i> Code d'acc√®s</label>
      <input type="password" id="pin" placeholder="‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢" maxlength="4" />
      <div id="pin-error" class="pin-error">Code incorrect. Veuillez r√©essayer.</div>
      <div class="last-update">Chauffeur: 1579 | Passagers: 2024</div>
    </div>

    <div id="content" class="hidden">
      <div id="user-type-indicator" class="user-type-indicator"></div>
      <div id="status-message" class="status hidden"></div>

      <div class="bus-line-info">
        <div class="bus-line-badge" id="bus-line-display">Ligne 4742</div>
      </div>

      <!-- DASHBOARD OMITTED FOR BREVITY, SAME STRUCTURE AS apres.txt -->
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.17.2/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.17.2/firebase-database-compat.min.js"></script>

  <script>
    const DRIVER_PIN = "1579";
    const PASSENGER_PIN = "2024";
    const BUS_LINE = "Line4742";

    let currentUserType = null;
    let currentBusPosition = null;

    const firebaseConfig = { /* same as avant.txt */ };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const trackingRef = database.ref('bustracking/' + BUS_LINE);

    const pinInput = document.getElementById('pin');
    const pinError = document.getElementById('pin-error');
    const contentDiv = document.getElementById('content');
    const userTypeIndicator = document.getElementById('user-type-indicator');
    const trackingData = document.getElementById('tracking-data');
    const currentPositionName = document.getElementById('current-position-name');
    const lastPositionName = document.getElementById('last-position-name');
    const lastPositionTime = document.getElementById('last-position-time');
    const cleanDataBtn = document.getElementById('clean-data');

    function formatDate(date) {
      return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
    }

    function parseDate(dateString) {
      let parsedDate = new Date(dateString);
      if (isNaN(parsedDate.getTime())) {
        const [datePart, timePart] = dateString.split(' ');
        const [day, month, year] = datePart.split('/');
        const [hours, minutes, seconds] = timePart.split(':');
        parsedDate = new Date(year, month - 1, day, hours, minutes, seconds);
      }
      return parsedDate;
    }

    function isToday(dateString) {
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const entryDate = parseDate(dateString);
      return !isNaN(entryDate.getTime()) && entryDate >= today;
    }

    function showStatus(message, isError = false) {
      const el = document.getElementById('status-message');
      el.textContent = message;
      el.className = 'status ' + (isError ? 'error' : 'success');
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    function addLocationEntry(locationName, latitude, longitude) {
      const now = new Date();
      const formattedDate = formatDate(now);
      const entry = { locationName, latitude, longitude, datetime: formattedDate };
      trackingRef.push(entry)
        .then(() => {
          showStatus(`Position '\${locationName}' enregistr√©e avec succ√®s`);
          loadTrackingData();
          if (currentUserType === 'passenger') updateLastPosition();
        })
        .catch(error => showStatus(`Erreur: \${error.message}`, true));
    }

    function loadTrackingData() {
      trackingData.innerHTML = '<tr><td colspan="2" class="loading">Chargement...</td></tr>';
      trackingRef.orderByChild('datetime').limitToLast(20).once('value')
        .then(snapshot => {
          const data = snapshot.val();
          if (!data) {
            trackingData.innerHTML = '<tr><td colspan="2">Aucune donn√©e</td></tr>';
            return;
          }
          const entries = Object.values(data).sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
          trackingData.innerHTML = entries.map(e => `<tr><td>\${e.locationName}</td><td>\${e.datetime}</td></tr>`).join('');
        });
    }

    function updateLastPosition() {
      trackingRef.orderByChild('datetime').limitToLast(1).once('value')
        .then(snapshot => {
          const data = snapshot.val();
          if (data) {
            const entry = Object.values(data)[0];
            lastPositionName.textContent = entry.locationName;
            lastPositionTime.textContent = `Mis √† jour: \${entry.datetime}`;
          }
        });
    }

    function purgeOldData() {
      showStatus('Nettoyage en cours...');
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const todayStr = today.toISOString().split('T')[0];
      trackingRef.once('value').then(snapshot => {
        const data = snapshot.val(); if (!data) return;
        const keysToDelete = [];
        for (const [key, entry] of Object.entries(data)) {
          const d = parseDate(entry.datetime);
          const entryStr = d.toISOString().split('T')[0];
          if (entryStr !== todayStr) keysToDelete.push(key);
        }
        return Promise.all(keysToDelete.map(k => trackingRef.child(k).remove()));
      }).then(() => {
        showStatus('Nettoyage termin√©');
        loadTrackingData();
      });
    }

    function fetchWeather() {
      const widget = document.getElementById('weather-widget');
      setTimeout(() => {
        widget.innerHTML = `<div class="weather-icon"><i class="fas fa-sun"></i></div>
          <div class="weather-info"><div class="weather-temp">24¬∞C</div><div class="weather-desc">Ensoleill√©</div></div>`;
      }, 500);
    }

    function initializeApp() {
      fetchWeather();
      loadTrackingData();
      if (currentUserType === 'passenger') updateLastPosition();
    }

    function initializeDriverMode() {
      pinInput.parentElement.classList.add('hidden');
      contentDiv.classList.remove('hidden');
      userTypeIndicator.textContent = "üöå Mode Chauffeur";
      userTypeIndicator.className = "user-type-indicator driver-mode";
      initializeApp();
      document.querySelectorAll('.bus-stop-btn').forEach(btn => {
        btn.onclick = () => {
          const name = btn.dataset.name;
          const lat = parseFloat(btn.dataset.lat);
          const lon = parseFloat(btn.dataset.lon);
          addLocationEntry(name, lat, lon);
        };
      });
      if (cleanDataBtn) cleanDataBtn.onclick = () => {
        if (confirm('Nettoyer toutes les donn√©es ?')) purgeOldData();
      };
    }

    function initializePassengerMode() {
      pinInput.parentElement.classList.add('hidden');
      contentDiv.classList.remove('hidden');
      userTypeIndicator.textContent = "üë• Mode Passager";
      userTypeIndicator.className = "user-type-indicator passenger-mode";
      initializeApp();
      setInterval(() => {
        loadTrackingData(); updateLastPosition();
      }, 30000);
    }

    function validatePin() {
      const pin = pinInput.value;
      if (pin === DRIVER_PIN) {
        currentUserType = 'driver';
        initializeDriverMode();
      } else if (pin === PASSENGER_PIN) {
        currentUserType = 'passenger';
        initializePassengerMode();
      } else {
        pinInput.classList.add('shake');
        pinError.style.display = 'block';
        setTimeout(() => pinInput.classList.remove('shake'), 500);
      }
    }

    pinInput.addEventListener('input', () => {
      if (pinInput.value.length === 4) validatePin();
      if (pinError.style.display === 'block') pinError.style.display = 'none';
    });

    pinInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') validatePin();
    });
  </script>
</body>
</html>
