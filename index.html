<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test API Bus Tracking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #4285f4;
      text-align: center;
      margin-bottom: 20px;
    }
    h2 {
      color: #555;
      margin-top: 0;
    }
    .section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      background-color: #fafafa;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    input, button {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    input {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #4285f4;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #357ae8;
    }
    button.secondary {
      background-color: #5cb85c;
    }
    button.secondary:hover {
      background-color: #4cae4c;
    }
    #mapContainer {
      height: 300px;
      width: 100%;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #response {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      min-height: 100px;
      max-height: 300px;
      overflow: auto;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .stops-list {
      margin-top: 20px;
      max-height: 300px;
      overflow: auto;
    }
    .stop-item {
      padding: 10px;
      margin-bottom: 5px;
      border: 1px solid #eee;
      border-radius: 4px;
      background-color: white;
    }
    .stop-name {
      font-weight: bold;
      color: #4285f4;
    }
    .stop-time {
      color: #d14836;
      margin-left: 5px;
    }
    .buttons-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .buttons-row button {
      flex: 1;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .success {
      background-color: #dff0d8;
      color: #3c763d;
      border: 1px solid #d6e9c6;
    }
    .error {
      background-color: #f2dede;
      color: #a94442;
      border: 1px solid #ebccd1;
    }
    .loading {
      text-align: center;
      display: none;
      padding: 10px;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 2s linear infinite;
      display: inline-block;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .stop-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .stop-table th, .stop-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .stop-table tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .stop-table th {
      background-color: #4285f4;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Test de l'API Bus Tracking</h1>
    
    <div class="section">
      <h2>Ajouter un arrêt</h2>
      <form id="addStopForm">
        <label for="name">Nom de l'arrêt:</label>
        <input type="text" id="name" name="name" required>
        
        <label for="time">Heure (HH:MM:SS):</label>
        <input type="text" id="time" name="time" required>
        
        <label for="lat">Latitude:</label>
        <input type="number" id="lat" name="lat" step="0.000001" value="36.723456" required>
        
        <label for="lng">Longitude:</label>
        <input type="number" id="lng" name="lng" step="0.000001" value="3.198765" required>
        
        <div class="buttons-row">
          <button type="button" onclick="addStop()">Ajouter l'arrêt</button>
          <button type="button" class="secondary" onclick="getCurrentPosition()">Utiliser ma position</button>
        </div>
      </form>
      
      <div id="statusAdd" class="status"></div>
    </div>
    
    <div class="section">
      <h2>Récupérer les arrêts</h2>
      <button type="button" onclick="getStops()">Obtenir tous les arrêts d'aujourd'hui</button>
      <div id="statusGet" class="status"></div>
      
      <div id="loading" class="loading">
        <div class="loader"></div> Chargement des données...
      </div>
      
      <div id="stopsContainer" class="stops-list" style="display: none;">
        <h3>Arrêts enregistrés aujourd'hui</h3>
        <div id="currentDate" style="text-align: center; font-weight: bold; margin-bottom: 10px;"></div>
        <table class="stop-table">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Heure</th>
              <th>Latitude</th>
              <th>Longitude</th>
            </tr>
          </thead>
          <tbody id="stopsTableBody">
            <!-- Les arrêts seront ajoutés ici dynamiquement -->
          </tbody>
        </table>
      </div>
      
      <div id="response"></div>
    </div>
    
    <div class="section">
      <h2>Actions de maintenance</h2>
      <div class="buttons-row">
        <button type="button" onclick="testAddStop()">Tester l'ajout</button>
        <button type="button" onclick="recreerFeuillePassages()">Recréer feuille + test</button>
      </div>
      <div id="statusMaintenance" class="status"></div>
    </div>
  </div>

  <script>
    // URL du script Google Apps Script
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxzs3Eqsuflye5HHAttnHKDCUCUc7-PxNE2KIcNBqUlAzh5dc-CaURTu-p5RN-pXcMb/exec';
    
    // Mettre à jour l'heure actuelle au chargement de la page
    window.onload = function() {
      document.getElementById('time').value = new Date().toTimeString().slice(0, 8);
      displayCurrentDate();
      // Charger les arrêts automatiquement au démarrage
      getStops();
    };
    
    // Afficher la date du jour
    function displayCurrentDate() {
      const today = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDate').textContent = today.toLocaleDateString('fr-FR', options);
    }
    
    // Fonction pour obtenir la position actuelle
    function getCurrentPosition() {
      showLoading(true);
      showStatus('statusAdd', '', '');
      
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            document.getElementById('lat').value = position.coords.latitude;
            document.getElementById('lng').value = position.coords.longitude;
            showLoading(false);
            showStatus('statusAdd', 'success', 'Position récupérée avec succès.');
          },
          (error) => {
            showLoading(false);
            showStatus('statusAdd', 'error', 'Erreur lors de la récupération de la position: ' + error.message);
          },
          { enableHighAccuracy: true }
        );
      } else {
        showLoading(false);
        showStatus('statusAdd', 'error', 'La géolocalisation n\'est pas supportée par votre navigateur.');
      }
    }
    
    // Fonction pour ajouter un arrêt
    function addStop() {
      showLoading(true);
      showStatus('statusAdd', '', '');
      
      const name = document.getElementById('name').value;
      const time = document.getElementById('time').value;
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);
      
      if (!name || !time || isNaN(lat) || isNaN(lng)) {
        showLoading(false);
        showStatus('statusAdd', 'error', 'Veuillez remplir tous les champs correctement.');
        return;
      }
      
      // Construction de l'URL pour la requête GET
      const url = `${SCRIPT_URL}?action=addStop&name=${encodeURIComponent(name)}&time=${encodeURIComponent(time)}&lat=${lat}&lng=${lng}`;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          showLoading(false);
          if (data.success) {
            showStatus('statusAdd', 'success', 'Arrêt ajouté avec succès: ' + data.message);
            document.getElementById('name').value = '';
            document.getElementById('time').value = new Date().toTimeString().slice(0, 8);
            // Actualiser la liste des arrêts
            getStops();
          } else {
            showStatus('statusAdd', 'error', 'Erreur: ' + (data.error || 'Échec de l\'ajout'));
          }
        })
        .catch(error => {
          showLoading(false);
          showStatus('statusAdd', 'error', 'Erreur de communication avec le serveur: ' + error.message);
        });
    }
    
    // Fonction pour récupérer tous les arrêts
    function getStops() {
      showLoading(true);
      showStatus('statusGet', '', '');
      document.getElementById('stopsContainer').style.display = 'none';
      document.getElementById('response').textContent = '';
      
      fetch(`${SCRIPT_URL}?action=getStops`)
        .then(response => response.json())
        .then(data => {
          showLoading(false);
          
          // Afficher les données brutes dans la console pour le débogage
          console.log("Données reçues:", data);
          
          // Formater la réponse JSON pour l'affichage
          document.getElementById('response').textContent = JSON.stringify(data, null, 2);
          
          if (data.success) {
            if (data.stops && data.stops.length > 0) {
              showStatus('statusGet', 'success', `${data.stops.length} arrêt(s) récupéré(s) pour aujourd'hui.`);
              populateStopsTable(data.stops);
              document.getElementById('stopsContainer').style.display = 'block';
            } else {
              showStatus('statusGet', 'success', 'Aucun arrêt enregistré pour aujourd\'hui.');
              document.getElementById('stopsTableBody').innerHTML = '<tr><td colspan="4" style="text-align:center;">Aucun arrêt enregistré pour aujourd\'hui</td></tr>';
              document.getElementById('stopsContainer').style.display = 'block';
            }
          } else {
            showStatus('statusGet', 'error', 'Erreur: ' + (data.error || 'Échec de la récupération'));
          }
        })
        .catch(error => {
          showLoading(false);
          showStatus('statusGet', 'error', 'Erreur de communication avec le serveur: ' + error.message);
        });
    }
    
    // Fonction pour peupler le tableau des arrêts
    function populateStopsTable(stops) {
      const tableBody = document.getElementById('stopsTableBody');
      tableBody.innerHTML = '';
      
      // Trier les arrêts par heure
      stops.sort((a, b) => {
        return a.time.localeCompare(b.time);
      });
      
      stops.forEach(stop => {
        const row = document.createElement('tr');
        
        const nameCell = document.createElement('td');
        nameCell.textContent = stop.name;
        row.appendChild(nameCell);
        
        const timeCell = document.createElement('td');
        timeCell.textContent = stop.time;
        row.appendChild(timeCell);
        
        const latCell = document.createElement('td');
        latCell.textContent = stop.lat;
        row.appendChild(latCell);
        
        const lngCell = document.createElement('td');
        lngCell.textContent = stop.lng;
        row.appendChild(lngCell);
        
        tableBody.appendChild(row);
      });
    }
    
    // Fonction pour tester l'ajout d'un arrêt
    function testAddStop() {
      showLoading(true);
      showStatus('statusMaintenance', '', '');
      
      const testData = {
        name: "Test automatique",
        time: new Date().toTimeString().slice(0, 8),
        lat: 36.723456,
        lng: 3.198765
      };
      
      // Utiliser une requête GET pour l'ajout du test
      const url = `${SCRIPT_URL}?action=addStop&name=${encodeURIComponent(testData.name)}&time=${encodeURIComponent(testData.time)}&lat=${testData.lat}&lng=${testData.lng}`;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          showLoading(false);
          if (data.success) {
            showStatus('statusMaintenance', 'success', 'Test réussi: ' + data.message);
            // Actualiser la liste des arrêts
            getStops();
          } else {
            showStatus('statusMaintenance', 'error', 'Échec du test: ' + (data.error || 'Erreur inconnue'));
          }
        })
        .catch(error => {
          showLoading(false);
          showStatus('statusMaintenance', 'error', 'Erreur de communication: ' + error.message);
        });
    }
    
    // Fonction pour recréer la feuille de passages
    function recreerFeuillePassages() {
      if (!confirm('Êtes-vous sûr de vouloir recréer la feuille ? Cela supprimera toutes les données existantes.')) {
        return;
      }
      
      showLoading(true);
      showStatus('statusMaintenance', '', '');
      
      // Exécuter la fonction depuis Apps Script via une requête JSONP
      const scriptElement = document.createElement('script');
      const callbackName = 'callback_' + Math.random().toString(36).substr(2, 9);
      
      // Créer une fonction de rappel globale
      window[callbackName] = function(response) {
        showLoading(false);
        if (response && response.success) {
          showStatus('statusMaintenance', 'success', 'Feuille recréée avec succès!');
          // Actualiser la liste des arrêts
          setTimeout(getStops, 1000);
        } else {
          showStatus('statusMaintenance', 'error', 'Échec de la recréation: ' + (response.error || 'Erreur inconnue'));
        }
        
        // Supprimer la fonction de rappel et l'élément script
        delete window[callbackName];
        document.body.removeChild(scriptElement);
      };
      
      // Construire l'URL avec un paramètre de rappel
      scriptElement.src = `${SCRIPT_URL}?action=recreerFeuillePassages&callback=${callbackName}`;
      document.body.appendChild(scriptElement);
      
      // Si après 10 secondes, nous n'avons pas de réponse, considérer comme un timeout
      setTimeout(() => {
        if (window[callbackName]) {
          showLoading(false);
          showStatus('statusMaintenance', 'error', 'Timeout: Aucune réponse du serveur après 10 secondes');
          
          // Nettoyer
          delete window[callbackName];
          if (document.body.contains(scriptElement)) {
            document.body.removeChild(scriptElement);
          }
        }
      }, 10000);
    }
    
    // Fonction utilitaire pour afficher/masquer le chargement
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
    
    // Fonction utilitaire pour afficher les statuts
    function showStatus(elementId, type, message) {
      const element = document.getElementById(elementId);
      if (!message) {
        element.style.display = 'none';
        return;
      }
      
      element.className = 'status ' + type;
      element.textContent = message;
      element.style.display = 'block';
      
      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          element.style.display = 'none';
        }, 5000);
      }
    }
  </script>
</body>
</html>
