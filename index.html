<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suivi du Passage du Bus</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; }
    #map { height: 500px; width: 100%; border: 1px solid #ccc; margin-bottom: 20px; }
    button { display: block; margin: 10px auto; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #45a049; }
    #estimationInfo { margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; text-align: center; display: none; }
  </style>
</head>
<body>
  <h1>Suivi du Passage du Bus</h1>
  <div id="map"></div>
  <button id="busPassedBtn">Le bus est passé chez moi</button>
  <button id="refreshBtn">Rafraîchir les données</button>
  
  <div id="estimationInfo">
    <div class="estimation-title">Estimation d'arrivée:</div>
    <div id="estimationTime" class="estimation-time"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([36.7735, 3.0582], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    const BNH_POSITION = [36.716111, 3.201667]; 
    const BUS_SPEED = 30; 
    let markers = [];

    document.getElementById('busPassedBtn').addEventListener('click', handleBusPassed);
    document.getElementById('refreshBtn').addEventListener('click', fetchStops);

    function fetchStops() {
      fetch('https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?action=getStops')
        .then(response => response.json())
        .then(data => {
          clearMarkers();
          data.stops.forEach(stop => {
            const marker = L.marker([stop.lat, stop.lng]).addTo(map)
              .bindPopup(`${stop.name} - ${stop.time}`);
            markers.push(marker);
          });
          calculateEstimation(data.stops);
        })
        .catch(error => console.error("Erreur lors de la récupération des arrêts:", error));
    }

    function handleBusPassed() {
      const name = prompt("Votre prénom ?");
      if (!name) return;

      navigator.geolocation.getCurrentPosition(pos => {
        const position = [pos.coords.latitude, pos.coords.longitude];
        sendPosition(name, position);
        L.marker(position).addTo(map).bindPopup(`${name} - ${new Date().toLocaleTimeString()}`).openPopup();
      }, error => alert("Impossible d'obtenir votre position."));
    }

    function sendPosition(name, position) {
      fetch('https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, time: new Date().toLocaleTimeString(), lat: position[0], lng: position[1] })
      }).then(() => fetchStops()).catch(error => console.error("Erreur:", error));
    }

    function calculateEstimation(stops) {
      let closestStop = stops.reduce((prev, curr) => {
        let distPrev = calculateDistance(prev.lat, prev.lng, BNH_POSITION[0], BNH_POSITION[1]);
        let distCurr = calculateDistance(curr.lat, curr.lng, BNH_POSITION[0], BNH_POSITION[1]);
        return distCurr < distPrev ? curr : prev;
      });

      const distance = calculateDistance(closestStop.lat, closestStop.lng, BNH_POSITION[0], BNH_POSITION[1]);
      const estimatedMinutes = Math.round((distance / BUS_SPEED) * 60);
      const estimatedTime = new Date(new Date().getTime() + estimatedMinutes * 60000);
      document.getElementById('estimationTime').innerHTML = `Arrivée estimée: ${estimatedTime.toLocaleTimeString()} (dans ~${estimatedMinutes} min)`;
      document.getElementById('estimationInfo').style.display = 'block';
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
    }

    fetchStops();
  </script>
</body>
</html>
